FROM node:12.22.1-buster-slim
# docker pull louissung/rc:build-3.14.0-de64

ENV RC_VERSION=3.14.0 HOME=/app
WORKDIR /app
RUN groupadd -r rocketchat && useradd -r -g rocketchat rocketchat \
    && apt-get update && apt-get install -y --no-install-recommends \
            ca-certificates curl fontconfig git make openssh-server python vim \
            libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libgconf-2-4 libnss3 libxss1 libasound2 libxtst6 xauth xvfb \
        && aptMark="$(apt-mark showmanual)" && apt-get install -y --no-install-recommends \
            g++ \
        && rm -rf /var/lib/apt/lists/* \
    \
    && curl https://install.meteor.com/?release=2.1.1 | sh \
    && meteor npm install -g yarn && yarn config set install.prefer-offline true \
    \
    # clone source code and install dependencies
    && git clone --branch v1.25.0 https://github.com/RocketChat/Rocket.Chat.Apps-engine /app/Rocket.Chat.Apps-engine \
    && cd /app/Rocket.Chat.Apps-engine && yarn install && yarn run compile \
    && git clone --branch 3.14.0 https://github.com/RocketChat/Rocket.Chat /app/Rocket.Chat \
    && cd /app/Rocket.Chat && meteor yarn add ../Rocket.Chat.Apps-engine \
    \
    && echo -e 'pcm.!default {\n type hw\n card 0\n}\n\nctl.!default {\n type hw\n card 0\n}' > /app/.asoundrc \
    && meteor yarn run testunit --exclude app/models/server/models/Sessions.tests.js \
    && (TEST_MODE=true meteor run --allow-superuser & sleep 9m) && meteor yarn run test && pkill node \
    \
    && meteor --allow-superuser build --server-only --directory /app \
    && cd /app/bundle/programs/server && yarn install \
    \
    # purge build-deps (the g++ may lead the critical vulnerability `CVE-2019-19814`)
    && apt-mark auto '.*' > /dev/null && apt-mark manual $aptMark > /dev/null \
    && find /usr/local -type f -executable -exec ldd '{}' ';' | awk '/=>/ { print $(NF-1) }' | sort -u | xargs -r dpkg-query --search | cut -d: -f1 | sort -u | xargs -r apt-mark manual \
    && apt-get purge -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false \
    \
    && mv /app/Rocket.Chat/.git /app/rc.git && mv /app/Rocket.Chat.Apps-engine /app/rcae.git \
    && rm -rf /app/bundle /app/Rocket.Chat /app/Rocket.Chat.Apps-engine && mkdir -p /app/Rocket.Chat /app/Rocket.Chat.Apps-engine \
    && mv /app/rc.git /app/Rocket.Chat/.git && mv /app/rcae.git /app/Rocket.Chat.Apps-engine \
    \
    # grant file access permission for all users (also require setting the `HOME=/app` to share caches across users)
    && chown -R rocketchat:rocketchat /app && chmod -R ugo+rwX /app
