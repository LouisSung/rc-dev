FROM node:12.22.1-buster-slim
# docker pull louissung/rc:build-3.14.0-890c

ENV RC_VERSION=3.14.0
WORKDIR /app
RUN groupadd -r rocketchat && useradd -r -g rocketchat rocketchat\
    && apt-get update &&  apt-get install -y --no-install-recommends \
            ca-certificates curl git fontconfig openssh-server vim \
        && aptMark="$(apt-mark showmanual)" && apt-get install -y --no-install-recommends \
            g++ make python \
        && rm -rf /var/lib/apt/lists/* \
    && npm install -g node-gyp-cache && npm config set node_gyp node-gyp-cache \
    \
    && curl https://install.meteor.com/?release=2.1.1 | sh \
    \
    # clone source code and install dependencies
    && git clone --branch v1.25.0 https://github.com/RocketChat/Rocket.Chat.Apps-engine /app/Rocket.Chat.Apps-engine \
    && cd /app/Rocket.Chat.Apps-engine && npm install && npm run compile \
    && git clone --branch 3.14.0 https://github.com/RocketChat/Rocket.Chat /app/Rocket.Chat \
    && cd /app/Rocket.Chat && meteor npm install ../Rocket.Chat.Apps-engine \
    && git clone --branch 3.2.2 https://github.com/RocketChat/Rocket.Chat.Electron /app/Rocket.Chat.Electron \
    && cd /app/Rocket.Chat.Electron && yarn --check-files && yarn build \
    \
    && cd /app/Rocket.Chat \
    && (timeout 9m meteor run --inspect; exit 0) \
    && meteor --allow-superuser build --server-only --directory /app \
    && cd /app/bundle/programs/server && npm install \
    \
    # purge build-deps (the g++ may lead the critical vulnerability `CVE-2019-19814`)
    && apt-mark auto '.*' > /dev/null && apt-mark manual $aptMark > /dev/null \
    && find /usr/local -type f -executable -exec ldd '{}' ';' | awk '/=>/ { print $(NF-1) }' | sort -u | xargs -r dpkg-query --search | cut -d: -f1 | sort -u | xargs -r apt-mark manual \
    && apt-get purge -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false \
    \
    # purge source code and leave the build env only
    && mkdir /app/locks \
    && cd /app/Rocket.Chat && mv package-lock.json ../locks/rc-package-lock.json && rm -rf /app/bundle \
    && (git ls-files -z | xargs -0 rm -f) && (git ls-tree --name-only -d -r -z HEAD | sort -rz | xargs -0 rmdir || true) \
    && cd /app/Rocket.Chat.Apps-engine && mv package-lock.json ../locks/rc-ae-package-lock.json && rm -rf client definition lib server \
    && (git ls-files -z | xargs -0 rm -f) && (git ls-tree --name-only -d -r -z HEAD | sort -rz | xargs -0 rmdir || true) \
    && cd /app/Rocket.Chat.Electron && mv yarn.lock ../locks/rc-electron-yarn.lock && rm -rf app \
    && (git ls-files -z | xargs -0 rm -f) && (git ls-tree --name-only -d -r -z HEAD | sort -rz | xargs -0 rmdir || true) \
    \
    && chown -R rocketchat:rocketchat /app
